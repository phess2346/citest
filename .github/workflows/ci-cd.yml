name: NGINX CI/CD –ü–∞–π–ø–ª–∞–π–Ω

on:
  push:
    paths: ['index.html']
    branches: [main]

jobs:
  test_nginx:
    runs-on: ubuntu-latest
    name: üê≥ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ NGINX —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
    
    steps:
    - name: üì• –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: üöÄ –ó–∞–ø—É—Å–∫ NGINX –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
      run: |
        echo "–ó–∞–ø—É—Å–∫–∞—é Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å NGINX..."
        docker run -d \
          --name nginx-ci-${{ github.run_id }} \
          -p 9889:80 \
          -v $(pwd)/index.html:/usr/share/nginx/html/index.html \
          nginx:1.21-alpine
        
        echo "–û–∂–∏–¥–∞—é –∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
        sleep 3
        echo "‚úÖ NGINX –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 9889"
    
    - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞
      run: |
        echo "–ü—Ä–æ–≤–µ—Ä—è—é –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å NGINX..."
        MAX_RETRIES=5
        COUNTER=0
        
        while [ $COUNTER -lt $MAX_RETRIES ]; do
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:9889 || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ NGINX –æ—Ç–≤–µ—á–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (HTTP 200)"
            break
          else
            echo "üü° –ü–æ–ø—ã—Ç–∫–∞ $((COUNTER+1)): NGINX –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤ (–∫–æ–¥: $HTTP_CODE)"
            sleep 2
            COUNTER=$((COUNTER+1))
          fi
        done
        
        if [ "$HTTP_CODE" != "200" ]; then
          echo "‚ùå NGINX –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –∑–∞ –æ—Ç–≤–µ–¥–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è"
          exit 1
        fi
    
    - name: üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
      run: |
        echo "–ü—Ä–æ–≤–µ—Ä—è—é —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞..."
        
        LOCAL_HASH=$(md5sum index.html | cut -d' ' -f1)
        echo "–õ–æ–∫–∞–ª—å–Ω—ã–π —Ö–µ—à —Ñ–∞–π–ª–∞: $LOCAL_HASH"
        
        REMOTE_HASH=$(curl -s http://localhost:9889 | md5sum | cut -d' ' -f1)
        echo "–•–µ—à —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞: $REMOTE_HASH"
        
        if [ "$LOCAL_HASH" = "$REMOTE_HASH" ]; then
          echo "‚úÖ –¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!"
          echo "üìä –ö–æ–Ω—Ç–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ NGINX"
        else
          echo "‚ùå –û—à–∏–±–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏: –∫–æ–Ω—Ç–µ–Ω—Ç –±—ã–ª –∏–∑–º–µ–Ω–µ–Ω –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ"
          exit 1
        fi
    
    - name: üßπ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –∏ –æ—á–∏—Å—Ç–∫–∞
      if: always()
      run: |
        echo "–ó–∞–≤–µ—Ä—à–∞—é —Ä–∞–±–æ—Ç—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
        docker stop nginx-ci-${{ github.run_id }} 2>/dev/null && echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω" || echo "‚ö†Ô∏è –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        docker rm nginx-ci-${{ github.run_id }} 2>/dev/null && echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —É–¥–∞–ª–µ–Ω" || echo "‚ö†Ô∏è –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —É–∂–µ —É–¥–∞–ª–µ–Ω"
        
        echo "üßΩ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

  telegram_notify:
    needs: test_nginx
    runs-on: ubuntu-latest
    if: always()
    name: üì¢ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
    
    steps:
    - name: üì® –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          ${{ needs.test_nginx.result == 'success' && 'üéâ –£–°–ü–ï–®–ù–û–ï –í–´–ü–û–õ–ù–ï–ù–ò–ï' || 'üí• –û–®–ò–ë–ö–ê –í–´–ü–û–õ–ù–ï–ù–ò–Ø' }}
          
          –ü—Ä–æ–µ–∫—Ç: ${{ github.repository }}
          –í–µ—Ç–∫–∞: ${{ github.ref_name }}
          –ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä: ${{ github.actor }}
          
          ${{ needs.test_nginx.result == 'success' && '–í—Å–µ —ç—Ç–∞–ø—ã CI/CD –ø–∞–π–ø–ª–∞–π–Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!' || '–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –ø–∞–π–ø–ª–∞–π–Ω–∞.' }}
          
          ${{ needs.test_nginx.result == 'success' && '‚úÖ NGINX –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω' || '‚ùå –ü—Ä–æ–±–ª–µ–º—ã —Å NGINX' }}
          ${{ needs.test_nginx.result == 'success' && '‚úÖ HTTP –æ—Ç–≤–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω' || '‚ùå –û—à–∏–±–∫–∞ HTTP' }}
          ${{ needs.test_nginx.result == 'success' && '‚úÖ –ö–æ–Ω—Ç–µ–Ω—Ç –¥–æ—Å—Ç–∞–≤–ª–µ–Ω –±–µ–∑ –∏—Å–∫–∞–∂–µ–Ω–∏–π' || '‚ùå –ù–∞—Ä—É—à–µ–Ω–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞' }}
          
          –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
