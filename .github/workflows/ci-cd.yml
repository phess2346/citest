name: NGINX Telegram CI/CD

on:
  push:
    paths: ['index.html']
    branches: [main]

jobs:
  test_and_notify:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: üê≥ –ó–∞–ø—É—Å–∫ –∏ —Ç–µ—Å—Ç NGINX
      run: |
        # –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        docker run -d --name nginx-temp -p 9889:80 \
          -v $(pwd)/index.html:/usr/share/nginx/html/index.html \
          nginx:1.21-alpine
        sleep 5
        
        # –¢–µ—Å—Ç—ã
        curl -f http://localhost:9889 || exit 1
        LOCAL=$(md5sum index.html | cut -d' ' -f1)
        REMOTE=$(curl -s http://localhost:9889 | md5sum | cut -d' ' -f1)
        [ "$LOCAL" = "$REMOTE" ] || exit 1
        
        # –û—á–∏—Å—Ç–∫–∞
        docker rm -f nginx-temp
        
    - name: üì¢ TG –£—Å–ø–µ—Ö
      if: success()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          ‚úÖ –£–°–ü–ï–•: CI/CD –ø–∞–π–ø–ª–∞–π–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω! md5 —Å—É–º–º—ã —Å–æ–≤–ø–∞–¥–∞—é—Ç!
          –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}
          –°—Å—ã–ª–∫–∞: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

    - name: üì¢ TG –û—à–∏–±–∫–∞
      if: failure()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          ‚ùå –û–®–ò–ë–ö–ê: CI/CD –ø–∞–π–ø–ª–∞–π–Ω –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω! –°—É–º–º—ã md5 –Ω–µ —Å–æ–≤–ø–∞–ª–∏!
          –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}
          –°—Å—ã–ª–∫–∞: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
